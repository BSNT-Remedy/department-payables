{% extends "base.html" %}
{% block title %}Student's Information{% endblock %}
{% block content %}
<head>
    <style>   
* {
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;    
}
body {
    -webkit-font-smoothing: antialiased;
    background: #95A5A6;
}
h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 25px;
    font-size: 28px;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 10px 0;
    background-color: #F0E8D9;
    border-radius: 5px;
}
.department-header {
    text-align: center;
    font-size: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #ffffff;
    padding: 10px 0;
    margin-bottom: 15px;
    border-bottom: 1px solid #E0D7C7;
    background: #3055b9;
    margin-top: -5px;
}
/* Table Styles */
.table-container {
    margin: 10px 50px 50px;
    box-shadow: 0px 12px 24px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    display: block;
    max-height: 600px;
    background: #F5F5F5;
    border-radius: 5px;
}
.table-container::-webkit-scrollbar {
    width: 8px;
    background: #F5F5F5;
}
.table-container::-webkit-scrollbar-thumb {
    background: #A3BFFA;
    border-radius: 8px;
}
.table-container::-webkit-scrollbar-thumb:hover {
    background: #7F9FF5;
}
.lamesa {
    border-radius: 5px;
    font-size: 13px;
    border: none;
    border-collapse: collapse;
    width: 100%;
    max-width: 100%;
    white-space: nowrap;
    background-color: white;
}
.lamesa td, .lamesa th {
    text-align: center;
    padding: 10px;
}
.lamesa td {
    border-right: 1px solid #f8f8f8;
    font-size: 13px;
}
.lamesa thead th {
    color: #ffffff;
    background: linear-gradient(180deg, #334EAC 0%, #2E438F 100%);
}
.lamesa thead th:nth-child(odd) {
    background: linear-gradient(180deg, #324960 0%, #2D4156 100%);
}
.lamesa tr:nth-child(even) {
    background: #F9F9F9;
}
.lamesa td .view-data.image-view {
    display: flex;
    justify-content: center;
    align-items: center;
}
.lamesa td .view-data.image-view:where(:not(:has(img))) {
    color: #888;
    background: #F5F5F5;
    padding: 4px 8px;
    border-radius: 3px;
}
.Add, .edit-all-btn, .save-all-btn, .cancel-btn, .delete-btn, .add-course-btn, .yearBtn {
    display: inline-block;
    font-weight: 500;
    text-align: center;
    text-decoration: none;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.Add {
    background-color: #28A745;
    margin-right: 10px;
    padding: 7px 20px;
    font-size: 11px; 
}
.Add:hover, .Add:active {
    background-color: #218838;
}
.delete-btn {
    background-color: #DC3545;
    padding: 6px 12px;
    font-size: 12px;
}
.delete-btn:hover, .delete-btn:active {
    background-color: #B02A37;
}
.edit-controls .edit-all-btn,
.edit-controls .save-all-btn,
.edit-controls .cancel-btn {
    width: 80px;
    box-sizing: border-box;
    text-align: center;
    padding: 8px 0;
    font-size: 11px; 
}
.edit-controls {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    width: 168px; 
}
.edit-controls .edit-all-btn {
    background-color: #007BFF;
}
.edit-controls .edit-all-btn:hover, .edit-controls .edit-all-btn:active {
    background-color: #0056B3;
}
.edit-controls .save-all-btn {
    background-color: #28A745;
}
.edit-controls .save-all-btn:hover, .edit-controls .save-all-btn:active {
    background-color: #218838;
}
.edit-controls .cancel-btn {
    background-color: #DC3545;
}
.edit-controls .cancel-btn:hover, .edit-controls .cancel-btn:active {
    background-color: #B02A37;
}
.hidden {
    display: none !important;
}
.lamesa td input[type="text"], .lamesa td input[type="file"] {
    width: 90%;
    padding: 4px;
    margin: 0;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 12px;
    box-sizing: border-box;
    vertical-align: middle;
}
.lamesa td .view-data {
    vertical-align: middle;
    display: inline-block;
    padding: 4px;
}
.lamesa td img {
    max-width: 40px;
    max-height: 40px;
    object-fit: cover;
    border-radius: 3px;
}
.flash-messages {
    text-align: center;
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 6px;
    display: block;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
}
.flash-success {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    font-size: 13px;
    padding: 10px 15px;
}
.flash-error {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    font-size: 13px;
    padding: 10px 15px;
}
.flash-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    font-size: 13px;
    padding: 10px 15px;
}
.table-scroll-wrapper {
    max-height: 350px;
    overflow-y: auto;
}
form[method="GET"] {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-left: 7px;
    background-color: transparent;
}
form[method="GET"]::before {
    content: "FILTER BY YEAR:";
    font-size: 12px;
    font-weight: 500;
    color: #333;
    margin-right: 5px;
}
.controls-container {
    display: flex;
    justify-content: center; 
    align-items: center; 
}
.left-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    margin-top: -3px;
}
.add-course-form {
    gap: 10px;
}
.add-course-form input[type="text"][name="courseName"] {
    padding: 7px 12px;
    font-size: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #f9f9f9;
    width: 200px;
    box-sizing: border-box;
}
.add-course-form input[type="text"][name="courseName"]:focus {
    border-color: #007BFF;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}
.add-course-form .add-course-btn {
    padding: 8px 20px;
    font-size: 11px;
    font-weight: 500;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #28A745;
    color: #ffffff;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 16px;
}
.add-course-form .add-course-btn:hover {
    background-color: #218838;
    transform: scale(1.05);
}
/* Adjusted Modal Styles */
#addStudentModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
#addStudentModal:not(.hidden) {
    opacity: 1;
}
#addStudentModal .modal-content {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 20px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: scale(0.95);
    transition: transform 0.3s ease-in-out;
}
#addStudentModal:not(.hidden) .modal-content {
    transform: scale(1);
}
#addStudentModal h2 {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 15px;
}
#addStudentModal .modal-form > div {
    margin-bottom: 15px;
}
#addStudentModal label {
    font-size: 14px;
    font-weight: 500;
    color: #444;
    margin-bottom: 5px;
    display: block;
}
#addStudentModal input,
#addStudentModal select {
    width: 100%;
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
    background-color: #fff;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}
#addStudentModal input[name="nm"] {
    border-color: #ffcccc; /* Pinkish border for Name */
}
#addStudentModal select {
    appearance: none;
    background: #fff url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgNEw4IDhMNC40IDQuNCIgZmlsbD0iIzY2NiIvPjwvc3ZnPg==") no-repeat right 8px center;
    background-size: 10px;
}
#addStudentModal input:focus,
#addStudentModal select:focus {
    border-color: #007BFF;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
}
#addStudentModal button {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}
#addStudentModal button[type="submit"] {
    background-color: #28a745;
    color: #ffffff;
}
#addStudentModal button[type="submit"]:hover {
    background-color: #218838;
    transform: scale(1.05);
}
#addStudentModal #cancelModalBtn {
    background-color: #dc3545;
    color: #ffffff;
}
#addStudentModal #cancelModalBtn:hover {
    background-color: #c5303b;
    transform: scale(1.05);
}
#addStudentModal .button-group {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    gap: 10px;
}
.yearBtn {
    background-color: #007BFF;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    padding: 8px;
    margin: 0 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 11px;
}
.yearBtn:hover {
    background-color: #0056B3;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}
@media (max-width: 640px) {
    #addStudentModal .modal-content {
        max-width: 90%;
        padding: 16px;
    }
    #addStudentModal h2 {
        font-size: 18px;
        margin-bottom: 10px;
    }
    #addStudentModal input,
    #addStudentModal select {
        padding: 6px;
        font-size: 13px;
    }
    #addStudentModal button {
        padding: 6px 12px;
        font-size: 13px;
    }
    .add-course-form input[type="text"][name="courseName"] {
        width: 100%;
        max-width: 180px;
    }
}
@media (max-width: 768px) {
    .table-container {
        margin: 10px 15px;
    }
    .controls-container {
        display: flex;
        justify-content: center; 
        align-items: center; 
    }
    .left-controls {
        gap: 8px;
        align-items: center;
        margin-bottom: 5px;
    }
    form[method="GET"] {
        flex-wrap: wrap;
        gap: 5px;
    }
    form[method="GET"]::before {
        width: 100%;
        text-align: left;
    }
    .yearBtn {
        padding: 4px;
        margin: 0 3px;
    }
}
</style>
</head>

<h1>All Students</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
                <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="table-container">
    <!-- Department Header -->
    <h1 class="department-header">{{ department }}</h1>

    <!-- Add, Edit, and Filter Controls -->
    <div class="controls-container">
        <div class="left-controls">
            <button id="addStudentBtn" class="Add">Add Student</button>
            <form action="{{ url_for('add_course') }}" method="POST" class="add-course-form">
                <input type="text" name="courseName" placeholder="Course name" required>
                <input type="hidden" name="selectedDepartment" value="{{ department }}">
                <button type="submit" class="add-course-btn">Add Course</button>
            </form>
            <div class="edit-controls">
                <button id="editAllBtn" class="edit-all-btn">Edit</button>
                <button id="saveAllBtn" class="save-all-btn hidden">Save Changes</button>
                <button id="cancelChangesBtn" class="cancel-btn hidden">Cancel</button>
            </div>
        </div>
        <form method="GET" action="/students">
            <button class="yearBtn" name="year" type="submit" value="{{ current_first_year }}">1ST YEAR</button>
            <button class="yearBtn" name="year" type="submit" value="{{ current_first_year - 1 }}">2ND YEAR</button>
            <button class="yearBtn" name="year" type="submit" value="{{ current_first_year - 2 }}">3RD YEAR</button>
            <button class="yearBtn" name="year" type="submit" value="{{ current_first_year - 3 }}">4TH YEAR</button>
            <button class="yearBtn" name="year" type="submit" value="01">Irregular</button>
        </form>
    </div>

    <!-- Modal for Adding Student -->
    <div id="addStudentModal" class="hidden">
        <div class="modal-content">
            <h2>Add New Student</h2>
            <form action="{{ url_for('students') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-form">
                    <div>
                        <label for="name">Name</label>
                        <input type="text" id="name" name="nm" required>
                    </div>
                    <div>
                        <label for="course">Course</label>
                        <select id="course" name="course" required>
                            <option disabled selected>Choose course</option>
                            {% for dept in alldepartments %}
                                {% if dept.department_name == department %}
                                    {% for course in dept.courses %}
                                        <option value="0{{ course.id }}">{{ course.course_name }}</option>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="yrEn">
                        <label for="yearEntered">Year Entered</label>
                        <select id="yearEntered" name="yearEntered" required>
                            <option disabled selected>Choose year</option>
                            <option value="01">Irregular</option>
                            {% for x in range(2020, 2030) %}
                                <option>{{ x }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="yrEn">
                        <label for="student_status">Status</label>
                        <select id="student_status" name="student_status" required>
                            <option value="1">Regular</option>
                            <option value="0">Irregular</option>
                        </select>
                    </div>
                    <div class="Up">
                        <label for="image">Upload Image (Optional)</label>
                        <input type="file" id="image" name="image" accept="image/*">
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit">Add Student</button>
                    <button type="button" id="cancelModalBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <form id="editStudentsForm" method="POST" action="{{ url_for('update_all_students') }}" enctype="multipart/form-data">
        <div class="table-scroll-wrapper">
            <table class="lamesa">
                <thead>
                    <tr>
                        <th>Student Number</th>
                        <th>Name</th>
                        <th>Contact Number</th>
                        <th>Contact Person</th>
                        <th>Address</th>
                        <th>Image</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    {% for student in students_year %}
                    <tr id="student-row-{{ student.id }}">
                        <td>{{ student.student_number }}</td>
                        <td>
                            <span class="view-data name-view">{{ student.name }}</span>
                            <input type="text" name="name_{{ student.id }}" value="{{ student.name }}" class="edit-input name-edit hidden">
                        </td>
                        <td>
                            <span class="view-data contactNum-view">{{ student.contactNum }}</span>
                            <input type="text" name="contactNum_{{ student.id }}" value="{{ student.contactNum }}" class="edit-input contactNum-edit hidden">
                        </td>
                        <td>
                            <span class="view-data contactPerson-view">{{ student.contactPerson }}</span>
                            <input type="text" name="contactPerson_{{ student.id }}" value="{{ student.contactPerson }}" class="edit-input contactPerson-edit hidden">
                        </td>
                        <td>
                            <span class="view-data address-view">{{ student.address }}</span>
                            <input type="text" name="address_{{ student.id }}" value="{{ student.address }}" class="edit-input address-edit hidden">
                        </td>
                        <td>
                            <span class="view-data image-view">
                                {% if student.image_path %}
                                    <img src="{{ url_for('static', filename=student.image_path) }}" alt="Student Image">
                                {% else %}
                                    No Image
                                {% endif %}
                            </span>
                            <input type="file" name="image_{{ student.id }}" accept="image/*" class="edit-input image-edit hidden">
                        </td>
                        <td>
                            <span class="view-data status-view" data-value="{{ '1' if student.status else '0' }}">
                                {{ 'Regular' if student.status else 'Irregular' }}
                            </span>
<!--                            <input type="text" name="status_{{ student.id }}" value="{{ student.status }}" class="edit-input status-edit hidden">-->
                            <select name="status_{{ student.id }}" class="edit-input status-edit hidden">
                                    <option value="1" selected>Regular</option>
                                    <option value="0">Irregular</option>
                            </select>
                        </td>
                        <td>
                            <input type="hidden" name="student_ids" value="{{ student.id }}">
                            <button type="button" class="delete-btn" data-student-id="{{ student.id }}">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7">No students found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<script>

document.addEventListener('DOMContentLoaded', function () {
    // DOM References
    const flashMessages = document.querySelector('.flash-messages');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const addStudentModal = document.getElementById('addStudentModal');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const editAllBtn = document.getElementById('editAllBtn');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const cancelChangesBtn = document.getElementById('cancelChangesBtn');
    const studentsTableBody = document.getElementById('studentsTableBody');
    const editStudentsForm = document.getElementById('editStudentsForm');

    // Flash Messages Adjustment
    if (flashMessages) {
        const containerWidth = document.querySelector('.table-container').offsetWidth;
        flashMessages.style.maxWidth = containerWidth + 'px';
        flashMessages.style.width = 'auto';
        flashMessages.style.marginLeft = 'auto';
        flashMessages.style.marginRight = 'auto';
    }

    // Store original values for cancel functionality
    let originalValues = {};

    // setEditMode Function
    function setEditMode(isEditing) {
        editAllBtn.classList.toggle('hidden', isEditing);
        saveAllBtn.classList.toggle('hidden', !isEditing);
        cancelChangesBtn.classList.toggle('hidden', !isEditing);

        const rows = studentsTableBody.querySelectorAll('tr[id^="student-row-"]');
        rows.forEach(row => {
            const studentId = row.id.split('-').pop();
            if (isEditing && !originalValues[studentId]) {
                originalValues[studentId] = {};
            }

            const viewDataSpans = row.querySelectorAll('.view-data');
            const editInputs = row.querySelectorAll('.edit-input');

            viewDataSpans.forEach(span => {
                span.classList.toggle('hidden', isEditing);
                if (isEditing) {
                    const fieldClass = span.classList[1].split('-view')[0];
                    if (originalValues[studentId]) {
                        originalValues[studentId][fieldClass] = span.textContent.trim();
                    }
                }
            });

            editInputs.forEach(input => {
                input.classList.toggle('hidden', !isEditing);
                if (isEditing && input.type !== 'file') {
                    const fieldClass = input.classList[1].split('-edit')[0];
                    const spanElement = row.querySelector('.' + fieldClass + '-view');
                    if (spanElement) {
                        // Use data-value attribute instead of span text content
                        const val = spanElement.dataset.value !== undefined ? spanElement.dataset.value : spanElement.textContent.trim();
                        input.value = val;
                    }
                } else if (!isEditing && originalValues[studentId]) {
                    const fieldClass = input.classList[1].split('-edit')[0];
                    if (originalValues[studentId][fieldClass] !== undefined && input.type !== 'file') {
                        const spanElement = row.querySelector('.' + fieldClass + '-view');
                        if (spanElement) spanElement.textContent = originalValues[studentId][fieldClass];
                    }
                }
            });
        });

        if (!isEditing) {
            originalValues = {};
            const fileInputs = studentsTableBody.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => input.value = '');
        }
    }

    // Add Student Button (Open Modal)
    if (addStudentBtn && addStudentModal) {
        addStudentBtn.addEventListener('click', function () {
            console.log('Add Student button clicked'); // Debugging
            addStudentModal.classList.remove('hidden');
        });
    } else {
        console.error('Add Student button or modal not found:', { addStudentBtn, addStudentModal });
    }

    // Cancel Modal Button (Close Modal)
    if (cancelModalBtn && addStudentModal) {
        cancelModalBtn.addEventListener('click', function () {
            console.log('Cancel Modal button clicked'); // Debugging
            addStudentModal.classList.add('hidden');
            const form = addStudentModal.querySelector('form');
            if (form) form.reset();
        });
    } else {
        console.error('Cancel Modal button or modal not found:', { cancelModalBtn, addStudentModal });
    }

    // Edit Button (Enter Edit Mode)
    if (editAllBtn) {
        editAllBtn.addEventListener('click', function () {
            console.log('Edit button clicked'); // Debugging
            setEditMode(true);
        });
    } else {
        console.error('Edit button not found:', editAllBtn);
    }

    function toggleEditMode(studentId) {
      const span = document.querySelector(`span.status-view`);
      const select = document.querySelector(`select[name="status_${studentId}"]`);

      if (select.classList.contains('hidden')) {
        // Enter edit mode: show select, hide span
        span.classList.add('hidden');
        select.classList.remove('hidden');
      } else {
        // Exit edit mode: hide select, show span
        span.classList.remove('hidden');
        select.classList.add('hidden');
      }
    }


    // Save Changes Button (Submit Form)
    if (saveAllBtn) {
        saveAllBtn.addEventListener('click', function () {
            console.log('Save Changes button clicked'); // Debugging
            editStudentsForm.submit();
        });
    } else {
        console.error('Save Changes button not found:', saveAllBtn);
    }

    // Cancel Changes Button (Revert Changes)
    if (cancelChangesBtn) {
        cancelChangesBtn.addEventListener('click', function () {
            console.log('Cancel Changes button clicked'); // Debugging
            setEditMode(false);
        });
    } else {
        console.error('Cancel Changes button not found:', cancelChangesBtn);
    }

    // Delete Buttons
    document.querySelectorAll(".delete-btn").forEach(button => {
        button.addEventListener("click", function() {
            let studentId = this.getAttribute("data-student-id");
            if (confirm("Are you sure you want to delete this student?")) {
                fetch(`/delete_student/${studentId}`, { method: "DELETE" })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const rowToRemove = document.getElementById(`student-row-${studentId}`);
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }
                        if (studentsTableBody.querySelectorAll('tr[id^="student-row-"]').length === 0) {
                            const colspan = studentsTableBody.closest('table').querySelector('thead tr').childElementCount || 7;
                            studentsTableBody.innerHTML = `<tr><td colspan="${colspan}">No students found.</td></tr>`;
                        }
                    } else {
                        alert("Error deleting student: " + (data.message || data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Error deleting student. See console for details.");
                });
            }
        });
    });

    // Fallback for Empty Table
    if (studentsTableBody && studentsTableBody.querySelectorAll('tr[id^="student-row-"]').length === 0 && !studentsTableBody.querySelector('td[colspan]')) {
        const colspan = studentsTableBody.closest('table')?.querySelector('thead tr')?.childElementCount || 7;
        if (colspan > 0) {
            studentsTableBody.innerHTML = `<tr><td colspan="${colspan}">No students found.</td></tr>`;
        }
    }
});
</script>
{% endblock %}